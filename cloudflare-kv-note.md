# Cloudflare Workers KV のメモ

[Cloudflare Workers KV · Cloudflare Workers KV docs](https://developers.cloudflare.com/kv/)

- 名前の通り key-value ストア。AWS 見習え
- CDN のエッジにあるコードからアクセスできるわけで、すごい
- Workers とついてても Pages からも使える
- `wrangler dev` だとローカルでシミュレーション (--remote オプションがあるらしい)

## 無料枠の制限

(2025-04 現在)

引用元:
[Limits · Cloudflare Workers KV docs](https://developers.cloudflare.com/kv/platform/limits/)

| 項目                           | 無料プランの制限         |
| ------------------------------ | ------------------------ |
| 読み取り回数(Reads)            | 1 日あたり 100,000 回    |
| 書き込み(異なるキー)           | 1 日あたり 1,000 回      |
| 書き込み(同じキー)             | 1 秒あたり 1 回          |
| 1 ワーカー呼び出しあたりの操作 | 最大 1,000 回 (下記参照) |
| 名前空間(Namespaces)           | 最大 1,000 個            |
| アカウントあたりのストレージ   | 最大 1 GB                |
| 名前空間あたりのストレージ     | 最大 1 GB                |
| 名前空間あたりのキー数         | 無制限                   |
| キーのサイズ                   | 最大 512 バイト          |
| キーメタデータ                 | 最大 1,024 バイト        |
| 値のサイズ                     | 最大 25 MiB              |
| 最小 cacheTtl                  | 60 秒                    |

1 回のワーカー呼び出し(invocation)につき、
外部サービス(例:KV 読み取り、R2 読み取り)への操作は
**合計 1,000 回**
まで可能

### cacheTtl

- [CacheTtl parameter](https://developers.cloudflare.com/kv/api/read-key-value-pairs/#cachettl-parameter)
- [How KV works · Cloudflare Workers KV docs](https://developers.cloudflare.com/kv/concepts/how-kv-works/)

cacheTtl は、Cloudflare Workers KV でデータ取得時に指定できるパラメータで、「そのデータを Cloudflare のグローバルネットワーク内のキャッシュに何秒間保持するか」を決めるもの。

## Cloudflare Workers KV の仕組み

以下は
[How KV works · Cloudflare Workers KV docs](https://developers.cloudflare.com/kv/concepts/how-kv-works/)
を Perplexity に要約してもらって、それを修正したもの。

Cloudflare Workers KV は、グローバルに分散された低レイテンシなキーバリューストアです。  
「グローバルなキャッシュ付き KVS」として、**読み取り中心の用途**で非常に高いパフォーマンスを発揮します。ただし、**最終的整合性**であるため、リアルタイムな書き込み反映が必要な場合や書き込み頻度が高い場合は注意が必要です。

### 1. KV の基本構造

- **中央データストア**にデータを書き込み、**Cloudflare の各データセンター**(エッジ)にキャッシュとして分散保存します。
- 初回アクセス時はキャッシュがなく、中央ストアからデータを取得します。その後はエッジキャッシュから高速に返されます。

### 2. 読み書きの流れ

- **書き込み**:データは中央ストアに保存され、すぐに全リージョンへ反映されるわけではありません。
- **読み込み**:
  - 最初のリクエストは中央ストア(またはリージョンキャッシュ)まで到達し、遅くなります(コールドリード)。
  - 以降は、アクセスがあったエッジでキャッシュされ、同じ場所からのリクエストは高速にレスポンスされます。

### 3. キャッシュとパフォーマンス

- **cacheTtl**(キャッシュの有効期限)を調整することで、パフォーマンスを最適化できます(デフォルト 60 秒)。
- キャッシュされたデータは、cacheTtl の間はエッジで保持されます。
- キャッシュが切れると、再度中央ストアからデータを取得し、キャッシュを更新します。

### 4. 一貫性(Consistency)

- KV は **最終的整合性(eventual consistency)** を採用しています。
  - 書き込んだ場所では変更がすぐ見えることが多いですが、他リージョンではキャッシュの期限が切れるまで古いデータが返る場合があります(最大 60 秒以上)。
- **存在しないキー**の情報(ネガティブルックアップ)もキャッシュされるため、新規作成時にも同様の遅延があります。

### 5. ユースケースと注意点

#### 適した用途

- **読み取りが多い**(read-heavy)ワークロード
  - 静的アセット配信
  - アプリ設定の保存
  - ユーザープリファレンス
  - リスト管理(allow/deny リスト)
  - キャッシュ用途

#### 不向きな用途

- **書き込みが多い**(write-heavy)ワークロード
  - 例:同じキーを毎秒数十〜数百回更新する場合(Redis のような用途)
- その場合は**Durable Objects**の利用を推奨

### 6. 一貫性を高めたい場合

- **Durable Objects**を使い、全ての書き込みを一箇所に集約することで「write-after-write consistency(連続書き込みの整合性)」を担保できます。

### 7. セキュリティ

- KV のデータセキュリティについては、専用ドキュメントを参照してください。

## 「最終的整合性」とは

[結果整合性 - Wikipedia](https://ja.wikipedia.org/wiki/%E7%B5%90%E6%9E%9C%E6%95%B4%E5%90%88%E6%80%A7)

**最終的整合性(Eventual Consistency)**
とは、分散システムや分散データベースで使われる整合性モデルの一つです。  
このモデルでは、データの更新が全てのノードに伝播するまでに時間がかかることを許容しますが、「最終的には」全てのノードが同じデータを保持することを保証します。

最終的整合性は「一時的なデータの不一致を許容する代わりに、最終的には全ノードが同じデータに収束する」ことを保証するモデルで、
高可用性・スケーラビリティ・パフォーマンスを重視する分散システムで広く利用されています

### 特徴

- **一時的な不一致を許容**  
  データが更新されてから全ノードに反映されるまでの間、一部のノードでは古いデータが返されることがあります
- **最終的には一致**  
  時間が経過し、追加の更新がなければ、全てのノードが同じ(最新の)データを返すようになります
- **高可用性・高スケーラビリティ**  
  システムの一部に障害があっても、他の部分は動作し続けられるため、可用性が高くなります
- **パフォーマンス重視**  
  強整合性に比べて、書き込み・読み取りが高速です

### 強整合性との違い

| 特徴                   | 最終的整合性                    | 強整合性               |
| ---------------------- | ------------------------------- | ---------------------- |
| データ反映のタイミング | 遅延あり(最終的に一致)          | 即座に全ノードで一致   |
| 可用性                 | 高い                            | 場合によっては低下する |
| 不一致の可能性         | 一時的にあり                    | 常に最新データ         |
| 例                     | Cloudflare Workers KV、NoSQL 等 | 銀行システム、RDBMS 等 |
